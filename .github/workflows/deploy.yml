name: Deploy to NCP Server

on:
  push:
    branches: [ main, dev ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy to NCP Server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.NCP_HOST }}
        username: ${{ secrets.NCP_USERNAME }}
        password: ${{ secrets.NCP_PASSWORD }}
        port: 2222
        timeout: 70s
        command_timeout: 30m
        script: |
          # 절대 경로 사용
          mkdir -p /home/user/app
          cd /home/user/app

          # 환경변수 파일 생성
          echo "Creating .env file..."
          cat > /home/user/app/.env << EOL
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          ENV=${{ secrets.ENV }}
          URL=${{ secrets.URL }}
          DBPASSWORD=${{ secrets.DBPASSWORD }}
          DBURL=${{ secrets.DBURL }}
          CLIENTSECRET=${{ secrets.CLIENTSECRET }}
          FILEPATH=${{ secrets.FILEPATH }}
          CLOVAURL=${{ secrets.CLOVAURL }}
          GPTSKEY1=${{ secrets.GPTSKEY1 }}
          GPTSKEY2=${{ secrets.GPTSKEY2 }}
          GPTSKEY3=${{ secrets.GPTSKEY3 }}
          GPTSKEY4=${{ secrets.GPTSKEY4 }}
          GPTSKEY5=${{ secrets.GPTSKEY5 }}
          EMAIL_USERNAME=${{ secrets.EMAIL_USERNAME }}
          EMAIL_PASSWORD=${{ secrets.EMAIL_PASSWORD }}
          TOSS_SECRET_KEY=${{ secrets.TOSS_SECRET_KEY }}
          EOL

          # 환경변수 파일 확인
          echo "Checking .env file..."
          cat /home/user/app/.env

          # Git 업데이트
          git fetch origin dev
          git reset --hard origin/dev

          # PM2 재시작
          pm2 reload ecosystem.config.cjs || pm2 start ecosystem.config.cjs
          pm2 save